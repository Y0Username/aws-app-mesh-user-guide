# Gateway routes<a name="gateway-routes"></a>

A gateway route is attached to a virtual gateway and routes traffic to an existing virtual service\. If a route matches a request, it can distribute traffic to a target virtual service\. This topic helps you work with gateway routes in a service mesh\.

## Creating a gateway route<a name="create-gateway-route"></a>

To create a gateway route using the AWS CLI version 1\.18\.116 or later, see the examples in the AWS CLI reference for the [create\-gateway\-route](https://docs.aws.amazon.com/cli/latest/reference/appmesh/create-gateway-route.html) command\.

**To create a gateway route using the AWS Management Console**

1. Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\. 

1. Choose the mesh that you want to create the gateway route in\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.

1. Choose **Virtual gateways** in the left navigation\.

1. Choose the virtual gateway that you want to associate a new gateway route with\. If none are listed, then you need to [create a virtual gateway](virtual_gateways.md#create-virtual-gateway) first\. You can only create a gateway route for a virtual gateway that your account is listed as the **Resource owner** of\.

1. In the **Gateway routes** table, choose **Create gateway route**\.

1. For **Gateway route name**, specify the name to use for your gateway route\.

1. For **Gateway route type**, enter a name for the gateway route\.

1. For **Gateway route type** choose one of the following protocols\.
   + **http** or **http2** – Specify a **Match prefix**\. A matched request by a gateway route is rewritten to the target virtual service's name and the matched prefix is rewritten to `/`, by default\. For example, if you have configured the **Match prefix** to be `/`, when a request is received for `www.example.com/chapter/page`, it would match the prefix, because it has a `/` after the host name\. The request would be rewritten to the name of a virtual service, such as `myservicea.svc.cluster.local/chapter/page`\. 

     Depending on how you configure your virtual service, it could use a virtual router to route the request to different virtual nodes, based on specific prefixes or headers\. If the **Match prefix** in the gateway route example were `/chapter`, rather than `/`, then:
     + A request to `www.example.com/chapter/page` would be re\-written to `www.example.com/page`\. Since `chapter` was the matched prefix, it would be removed in the re\-written request\. 
     + A request to `www.example.com/chapter1` would be rewritten to `www.example.com/1`\. Again, `chapter` was removed, since it was the matched prefix, but `/1` would be added to the rewritten request from the original request\. 

     Provided the virtual service’s virtual router has a route defined with a prefix of `/1` or `/page`, the request would be routed to a virtual node\. If the virtual service's virtual router doesn't have such a route however, the request would be dropped\. This behavior enables you to minimize the number of gateway routes that are needed, but does require you to ensure that you have routes for a virtual service’s virtual router for each of the expected prefixes that may be requested\. Learn more about [ Virtual services  A virtual service is an abstraction of a real service that is provided by a virtual node directly or indirectly by means of a virtual router\. Dependent services call your virtual service by its `virtualServiceName`, and those requests are routed to the virtual node or virtual router that is specified as the provider for the virtual service\.  Creating a virtual service  To create a virtual service using the AWS CLI version 1\.18\.116 or higher, see the example in the AWS CLI reference for the [create\-virtual\-service](https://docs.aws.amazon.com/cli/latest/reference/appmesh/create-virtual-service.html) command\.  To create a virtual service using the AWS Management Console  Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\.    Choose the mesh that you want to create the virtual service in\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.   Choose **Virtual services** in the left navigation\.   Choose **Create virtual service**\.   For **Virtual service name**, choose a name for your virtual service\. You can choose any name, but the service discovery name of the real service that you're targeting, such as `my-service.default.svc.cluster.local`, is recommended to make it easier to correlate your virtual services to real services and so that you don't need to change your code to reference a different name than your code currently references\. The name that you specify must resolve to a non\-loopback IP address because the app container must be able to successfully resolve the name before the request is sent to the Envoy proxy\. You can use any non\-loopback IP address because neither the app or proxy containers communicate with this IP address\. The proxy communicates with other virtual services through the names you’ve configured for them in App Mesh, not through IP addresses that the names resolve to\.   For **Provider**, choose the provider type for your virtual service:   If you want the virtual service to spread traffic across multiple virtual nodes, select **Virtual router** and then choose the virtual router to use from the drop\-down menu\.   If you want the virtual service to reach a virtual node directly, without a virtual router, select **Virtual node** and then choose the virtual node to use from the drop\-down menu\.  App Mesh may automatically create a default Envoy route retry policy for each virtual node provider that you define on or after July 29, 2020, even though you can't define such a policy through the App Mesh API\. For more information, see [Default route retry policy](envoy.md#default-retry-policy)\.    If you don't want the virtual service to route traffic at this time \(for example, if your virtual nodes or virtual router doesn't exist yet\), choose **None**\. You can update the provider for this virtual service later\.     Choose **Create virtual service** to finish\.    ](virtual_services.md), [ Virtual routers  Virtual routers handle traffic for one or more virtual services within your mesh\. After you create a virtual router, you can create and associate routes for your virtual router that direct incoming requests to different virtual nodes\. 

![\[Image NOT FOUND\]](http://docs.aws.amazon.com/app-mesh/latest/userguide/images/virtual_router.png) Any inbound traffic that your virtual router expects should be specified as a *listener*\.  Creating a virtual router  To create a virtual router using the AWS CLI version 1\.18\.116 or higher, see the example in the AWS CLI reference for the [create\-virtual\-router](https://docs.aws.amazon.com/cli/latest/reference/appmesh/create-virtual-router.html) command\. To create a virtual router using the AWS Management Console  Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\.    Choose the mesh that you want to create the virtual router in\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.   Choose **Virtual routers** in the left navigation\.   Choose **Create virtual router**\.   For **Virtual router name**, specify a name for your virtual router\. Up to 255 letters, numbers, hyphens, and underscores are allowed\.   For **Listener**, specify a **Port** and **Protocol** for your virtual router\. The `http` listener permits connection transition to websockets\.   Choose **Create virtual router** to finish\.     Deleting a virtual router  To delete a virtual router using the AWS CLI, use the `aws appmesh delete-virtual-router` command\. For an example of deleting a virtual router using the AWS CLI, see [delete\-virtual\-router](https://docs.aws.amazon.com/cli/latest/reference/appmesh/delete-virtual-router.html)\.  You cannot delete a virtual router if it has any [routes](routes.md) or if it is specified as a provider for any [virtual service](virtual_services.md)\.  To delete a virtual router using the AWS Management Console   Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\.    Choose the mesh that you want to delete a virtual router from\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.   Choose **Virtual routers** in the left navigation\.   In the **Virtual Routers** table, choose the virtual router that you want to delete and select **Delete**\. To delete a virtual router, your account ID must be listed in either the **Mesh owner** or the **Resource owner** columns of the virtual router\.   In the confirmation box, type **delete** and then select **Delete**\.     Routes  A route is associated with a virtual router\. The route is used to match requests for the virtual router and to distribute traffic to its associated virtual nodes\. If a route matches a request, it can distribute traffic to one or more target virtual nodes\. You can specify relative weighting for each virtual node\. This topic helps you work with routes in a service mesh\.  Creating a route  To create a route using the AWS CLI version 1\.18\.116 or later, see the examples in the AWS CLI reference for the [create\-route](https://docs.aws.amazon.com/cli/latest/reference/appmesh/create-route.html) command\. To create a route using the AWS Management Console  Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\.    Choose the mesh that you want to create the route in\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.   Choose **Virtual routers** in the left navigation\.   Choose the virtual router that you want to associate a new route with\. If none are listed, then you need to [create a virtual router](virtual_routers.md#create-virtual-router) first\.   In the **Routes** table, choose **Create route**\. To create a route, your account ID must be listed as the **Resource owner** of the route\.   For **Route name**, specify the name to use for your route\.   For **Route type**, choose the protocol that you want to route\. The protocol that you select must match the listener protocol that you selected for your virtual router and the virtual node that you're routing traffic to\.   \(Optional\) For **Route priority**, specify a priority from 0\-1000 to use for your route\. Routes are matched based on the specified value, where 0 is the highest priority\.   For **Virtual node name**, select the existing App Mesh virtual node to route traffic to and specify a **Weight**\. You can choose **Add target** to add additional targets\. The percentage for all targets must add up to 100\. If no virtual nodes are listed, then you must [create](virtual_nodes.md#vn-create-virtual-node) one first\.   \(Optional\) Choose **Additional configuration**\. From the following protocols, choose the protocol that you selected for **Route type**, specify settings in the console as desired, and then select **Create route**\.     gRPC   \(Optional\) **Match**   \(Optional\) Enter the **Service name** of the destination service to match the request for\. If you don't specify a name, requests to any service are matched\.   \(Optional\) Enter the **Method name** of the destination method to match the request for\. If you don't specify a name, requests to any method are matched\. If you specify a method name, you must specify a service name\.    \(Optional\) **Metadata**  Choose **Add metadata**\.  \(Optional\) Enter the **Metadata name** that you want to route based on, select a **Match type**, and enter a **Match value**\. Selecting **Invert** will match the opposite\. For example, if you specify a **Metadata name** of `myMetadata`, a **Match type** of **Exact**, a **Match value** of `123`, and select **Invert**, then the route is matched for any request that has a metadata name that starts with anything other than `123`\.   \(Optional\) Select **Add metadata** to add up to ten metadata items\.     \(Optional\) **Retry policy**  A retry policy enables clients to protect themselves from intermittent network failures or intermittent server\-side failures\. A retry policy is optional, but recommended\. The retry timeout values define the duration of time between retry attempts\. If you don't define a retry policy, then App Mesh may automatically create a default policy for each of your routes\. For more information, see [Default route retry policy](envoy.md#default-retry-policy)\.  For **Retry timeout**, enter the number of units for the timeout duration\. A value is required if you select any protocol retry event\.   For **Retry timeout unit**, select a unit\. A value is required if you select any protocol retry event\.   For **Max retries**, enter the maximum number of retry attempts when the request fails\. A value is required if you select any protocol retry event\. We recommend a value of at least two\.   Select one or more **HTTP retry events**\. We recommend selecting at least **stream\-error** and **gateway\-error**\.   Select a **TCP retry event**\.   Select one or more **gRPC retry events**\. We recommend selecting at least **cancelled** and **unavailable**\.    **\(Optional\) Timeouts**   **Request timeout** – The default is 15 seconds\. If you specified a **Retry policy**, then the duration that you specify here should always be greater than or equal to the retry duration multiplied by the **Max retries** that you defined in the **Retry policy** so that your retry policy can complete\. If you specify a duration greater than 15 seconds, then make sure that the timeout specified for the listener of any virtual node **Target** is also greater than 15 seconds\. For more information, see [Virtual nodes](virtual_nodes.md)\.   **Idle duration** – The maximum amount of time that the route can be idle\.     HTTP and HTTP/2   \(Optional\) Match   Specify the **Prefix** that the route should match\. For example, if your virtual service name is `service-b.local` and you want the route to match requests to `service-b.local/metrics`, your prefix should be `/metrics`\. Specifying `/` routes all traffic\.   \(Optional\) Select a **Method**\.    \(Optional\) Select a **Scheme**\.     \(Optional\) Headers   \(Optional\) Select **Add header**\. Enter the **Header name** that you want to route based on, select a **Match type**, and enter a **Match value**\. Selecting **Invert** will match the opposite\. For example, if you specify a header named `clientRequestId` with a **Prefix** of `123`, and select **Invert**, then the route is matched for any request that has a header that starts with anything other than `123`\.   \(Optional\) Select **Add header**\. You can add up to ten headers\.     **\(Optional\) Retry policy**  A retry policy enables clients to protect themselves from intermittent network failures or intermittent server\-side failures\. A retry policy is optional, but recommended\. The retry timeout values define the duration of time between retry attempts\. If you don't define a retry policy, then App Mesh may automatically create a default policy for each of your routes\. For more information, see [Default route retry policy](envoy.md#default-retry-policy)\.  For **Retry timeout**, enter the number of units for the timeout duration\. A value is required if you select any protocol retry event\.   For **Retry timeout unit**, select a unit\. A value is required if you select any protocol retry event\.   For **Max retries**, enter the maximum number of retry attempts when the request fails\. A value is required if you select any protocol retry event\. We recommend a value of at least two\.   Select one or more **HTTP retry events**\. We recommend selecting at least **stream\-error** and **gateway\-error**\.   Select a **TCP retry event**\.    **\(Optional\) Timeouts**   **Request timeout** – The default is 15 seconds\. If you specified a **Retry policy**, then the duration that you specify here should always be greater than or equal to the retry duration multiplied by the **Max retries** that you defined in the **Retry policy** so that your retry policy can complete\. If you specify a duration greater than 15 seconds, then make sure that the timeout specified for the listener of any virtual node **Target** is also greater than 15 seconds\. For more information, see [Virtual nodes](virtual_nodes.md)\.   **Idle duration** – The maximum amount of time that the route can be idle\.     TCP   **\(Optional\) Timeouts**   **Idle duration** – The maximum amount of time that the route can be idle\.       Deleting a route  To delete a route using the AWS CLI version 1\.18\.116 or higher, see the example in the AWS CLI reference for the [https://docs.aws.amazon.com/cli/latest/reference/appmesh/delete-route.html](https://docs.aws.amazon.com/cli/latest/reference/appmesh/delete-route.html) command\. To delete a route using the AWS Management Console  Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\.    Choose the mesh that you want to delete a route from\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.   Choose **Virtual routers** in the left navigation\.   Choose the router that you want to delete a route from\.   In the **Routes** table, choose the route that you want to delete and select **Delete**\.   In the confirmation box, type **delete** and then select **Delete**\.     ](virtual_routers.md), and [ Routes  A route is associated with a virtual router\. The route is used to match requests for the virtual router and to distribute traffic to its associated virtual nodes\. If a route matches a request, it can distribute traffic to one or more target virtual nodes\. You can specify relative weighting for each virtual node\. This topic helps you work with routes in a service mesh\.  Creating a route  To create a route using the AWS CLI version 1\.18\.116 or later, see the examples in the AWS CLI reference for the [create\-route](https://docs.aws.amazon.com/cli/latest/reference/appmesh/create-route.html) command\. To create a route using the AWS Management Console  Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\.    Choose the mesh that you want to create the route in\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.   Choose **Virtual routers** in the left navigation\.   Choose the virtual router that you want to associate a new route with\. If none are listed, then you need to [create a virtual router](virtual_routers.md#create-virtual-router) first\.   In the **Routes** table, choose **Create route**\. To create a route, your account ID must be listed as the **Resource owner** of the route\.   For **Route name**, specify the name to use for your route\.   For **Route type**, choose the protocol that you want to route\. The protocol that you select must match the listener protocol that you selected for your virtual router and the virtual node that you're routing traffic to\.   \(Optional\) For **Route priority**, specify a priority from 0\-1000 to use for your route\. Routes are matched based on the specified value, where 0 is the highest priority\.   For **Virtual node name**, select the existing App Mesh virtual node to route traffic to and specify a **Weight**\. You can choose **Add target** to add additional targets\. The percentage for all targets must add up to 100\. If no virtual nodes are listed, then you must [create](virtual_nodes.md#vn-create-virtual-node) one first\.   \(Optional\) Choose **Additional configuration**\. From the following protocols, choose the protocol that you selected for **Route type**, specify settings in the console as desired, and then select **Create route**\.     gRPC   \(Optional\) **Match**   \(Optional\) Enter the **Service name** of the destination service to match the request for\. If you don't specify a name, requests to any service are matched\.   \(Optional\) Enter the **Method name** of the destination method to match the request for\. If you don't specify a name, requests to any method are matched\. If you specify a method name, you must specify a service name\.    \(Optional\) **Metadata**  Choose **Add metadata**\.  \(Optional\) Enter the **Metadata name** that you want to route based on, select a **Match type**, and enter a **Match value**\. Selecting **Invert** will match the opposite\. For example, if you specify a **Metadata name** of `myMetadata`, a **Match type** of **Exact**, a **Match value** of `123`, and select **Invert**, then the route is matched for any request that has a metadata name that starts with anything other than `123`\.   \(Optional\) Select **Add metadata** to add up to ten metadata items\.     \(Optional\) **Retry policy**  A retry policy enables clients to protect themselves from intermittent network failures or intermittent server\-side failures\. A retry policy is optional, but recommended\. The retry timeout values define the duration of time between retry attempts\. If you don't define a retry policy, then App Mesh may automatically create a default policy for each of your routes\. For more information, see [Default route retry policy](envoy.md#default-retry-policy)\.  For **Retry timeout**, enter the number of units for the timeout duration\. A value is required if you select any protocol retry event\.   For **Retry timeout unit**, select a unit\. A value is required if you select any protocol retry event\.   For **Max retries**, enter the maximum number of retry attempts when the request fails\. A value is required if you select any protocol retry event\. We recommend a value of at least two\.   Select one or more **HTTP retry events**\. We recommend selecting at least **stream\-error** and **gateway\-error**\.   Select a **TCP retry event**\.   Select one or more **gRPC retry events**\. We recommend selecting at least **cancelled** and **unavailable**\.    **\(Optional\) Timeouts**   **Request timeout** – The default is 15 seconds\. If you specified a **Retry policy**, then the duration that you specify here should always be greater than or equal to the retry duration multiplied by the **Max retries** that you defined in the **Retry policy** so that your retry policy can complete\. If you specify a duration greater than 15 seconds, then make sure that the timeout specified for the listener of any virtual node **Target** is also greater than 15 seconds\. For more information, see [Virtual nodes](virtual_nodes.md)\.   **Idle duration** – The maximum amount of time that the route can be idle\.     HTTP and HTTP/2   \(Optional\) Match   Specify the **Prefix** that the route should match\. For example, if your virtual service name is `service-b.local` and you want the route to match requests to `service-b.local/metrics`, your prefix should be `/metrics`\. Specifying `/` routes all traffic\.   \(Optional\) Select a **Method**\.    \(Optional\) Select a **Scheme**\.     \(Optional\) Headers   \(Optional\) Select **Add header**\. Enter the **Header name** that you want to route based on, select a **Match type**, and enter a **Match value**\. Selecting **Invert** will match the opposite\. For example, if you specify a header named `clientRequestId` with a **Prefix** of `123`, and select **Invert**, then the route is matched for any request that has a header that starts with anything other than `123`\.   \(Optional\) Select **Add header**\. You can add up to ten headers\.     **\(Optional\) Retry policy**  A retry policy enables clients to protect themselves from intermittent network failures or intermittent server\-side failures\. A retry policy is optional, but recommended\. The retry timeout values define the duration of time between retry attempts\. If you don't define a retry policy, then App Mesh may automatically create a default policy for each of your routes\. For more information, see [Default route retry policy](envoy.md#default-retry-policy)\.  For **Retry timeout**, enter the number of units for the timeout duration\. A value is required if you select any protocol retry event\.   For **Retry timeout unit**, select a unit\. A value is required if you select any protocol retry event\.   For **Max retries**, enter the maximum number of retry attempts when the request fails\. A value is required if you select any protocol retry event\. We recommend a value of at least two\.   Select one or more **HTTP retry events**\. We recommend selecting at least **stream\-error** and **gateway\-error**\.   Select a **TCP retry event**\.    **\(Optional\) Timeouts**   **Request timeout** – The default is 15 seconds\. If you specified a **Retry policy**, then the duration that you specify here should always be greater than or equal to the retry duration multiplied by the **Max retries** that you defined in the **Retry policy** so that your retry policy can complete\. If you specify a duration greater than 15 seconds, then make sure that the timeout specified for the listener of any virtual node **Target** is also greater than 15 seconds\. For more information, see [Virtual nodes](virtual_nodes.md)\.   **Idle duration** – The maximum amount of time that the route can be idle\.     TCP   **\(Optional\) Timeouts**   **Idle duration** – The maximum amount of time that the route can be idle\.       Deleting a route  To delete a route using the AWS CLI version 1\.18\.116 or higher, see the example in the AWS CLI reference for the [https://docs.aws.amazon.com/cli/latest/reference/appmesh/delete-route.html](https://docs.aws.amazon.com/cli/latest/reference/appmesh/delete-route.html) command\. To delete a route using the AWS Management Console  Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\.    Choose the mesh that you want to delete a route from\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.   Choose **Virtual routers** in the left navigation\.   Choose the router that you want to delete a route from\.   In the **Routes** table, choose the route that you want to delete and select **Delete**\.   In the confirmation box, type **delete** and then select **Delete**\.    ](routes.md)\.
**Important**  
You can't specify either `/aws-appmesh*` or `/aws-app-mesh*` for **Match prefix**\. These prefixes are reserved for future App Mesh internal use\.
If multiple gateway routes are defined, then a request is matched to the route with the longest prefix\. For example, if two gateway routes existed, with one having a prefix of `/chapter` and one having a prefix of `/`, then a request for `www.example.com/chapter/` would be matched to the gateway route with the `/chapter` prefix\.
   + **grpc** – Specify a **Service name**\. Depending on how you configure your virtual service, the virtual service could route the request to different virtual nodes based on method name or specific metadata, for example\. To learn more about virtual services, see [Virtual services](virtual_services.md)\. 
**Important**  
You can't specify `/aws.app-mesh*` or `aws.appmesh` for the **Service name**\. These service names are reserved for future App Mesh internal use\.

1. Select an existing **Virtual service name**\. If none are listed, then you need to create a [virtual service](virtual_services.md#create-virtual-service) first\.

1. Choose **Create gateway route** to finish\.

## Deleting a gateway route<a name="delete-gateway-route"></a>

To delete a route using the AWS CLI version 1\.18\.116 or higher, see the AWS CLI reference for the [https://docs.aws.amazon.com/cli/latest/reference/appmesh/delete-gateway-route.html](https://docs.aws.amazon.com/cli/latest/reference/appmesh/delete-gateway-route.html) command\.

**To delete a gateway route using the AWS Management Console**

1. Open the App Mesh console at [https://console\.aws\.amazon\.com/appmesh/](https://console.aws.amazon.com/appmesh/)\. 

1. Choose the mesh that you want to delete a gateway route from\. All of the meshes that you own and that have been [shared](sharing.md) with you are listed\.

1. Choose **Virtual gateways** in the left navigation\.

1. Choose the virtual gateway that you want to delete a gateway route from\.

1. In the **Gateway routes** table, choose the gateway route that you want to delete and select **Delete**\. You can only delete a gateway route if your account is listed for **Resource owner**\.

1. In the confirmation box, type **delete** and then select **Delete**\.