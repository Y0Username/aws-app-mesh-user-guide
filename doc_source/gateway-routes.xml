<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "file://zonbook/docbookx.dtd"
[
    <!ENTITY % xinclude SYSTEM "file://AWSShared/common/xinclude.mod">
    %xinclude;
    <!ENTITY % phrases-shared SYSTEM "file://AWSShared/common/phrases-shared.ent">
    %phrases-shared;
    <!ENTITY % phrases-appmesh SYSTEM "../shared/phrases-app-mesh.ent"> 
    %phrases-appmesh;
]>

<section role="topic" id="gateway-routes">
    <info>
        <title id="gateway-routes.title">Gateway routes</title>
    </info>
    <para>A gateway route is attached to a virtual gateway and routes traffic to an existing virtual
        service. If a route matches a request, it can distribute traffic to a target virtual
        service. This topic helps you work with gateway routes in a service mesh.</para>
    <section id="create-gateway-route">
        <info>
            <title id="create-gateway-route.title">Creating a gateway route</title>
        </info>
        <para>To create a gateway route using the &CLI; version &aws_cli_min_version; or later, see
            the examples in the &CLI; reference for the <ulink type="documentation"
                url="cli/latest/reference/appmesh/create-gateway-route.html"
                >create-gateway-route</ulink> command.</para>
        <procedure>
            <title>To create a gateway route using the &console;</title>
            <step>
                <para>&MESHConsoleSwitch;</para>
            </step>
            <step>
                <para>Choose the mesh that you want to create the gateway route in. All of the
                    meshes that you own and that have been <link linkend="sharing">shared</link>
                    with you are listed.</para>
            </step>
            <step>
                <para>Choose <guilabel>Virtual gateways</guilabel> in the left navigation.</para>
            </step>
            <step>
                <para>Choose the virtual gateway that you want to associate a new gateway route
                    with. If none are listed, then you need to <link
                        linkend="create-virtual-gateway">create a virtual gateway</link> first. You
                    can only create a gateway route for a virtual gateway that your account is
                    listed as the <guilabel>Resource owner</guilabel> of.</para>
            </step>
            <step>
                <para>In the <guilabel>Gateway routes</guilabel> table, choose <guilabel>Create
                        gateway route</guilabel>.</para>
            </step>
            <step>
                <para>For <guilabel>Gateway route name</guilabel>, specify the name to use for your
                    gateway route.</para>
            </step>
            <step>
                <para>For <guilabel>Gateway route type</guilabel> choose one of the following
                    protocols.</para>
                <itemizedlist>
                    <listitem>
                        <para><guilabel>http</guilabel> or <guilabel>http2</guilabel> &endash;
                            Specify a <guilabel>Match prefix</guilabel>. A matched request by a
                            gateway route is rewritten to the target virtual service's name and the
                            matched prefix is rewritten to <code>/</code>, by default. For example,
                            if you have configured the <guilabel>Match prefix</guilabel> to be
                                <code>/</code>, when a request is received for
                                <code>www.example.com/chapter/page</code>, it would match the
                            prefix, because it has a <code>/</code> after the host name. The request
                            would be rewritten to the name of a virtual service, such as
                                <code>myservicea.svc.cluster.local/chapter/page</code>. </para>
                        <para>Depending on how you configure your virtual service, it could use a
                            virtual router to route the request to different virtual nodes, based on
                            specific prefixes or headers. If the <guilabel>Match prefix</guilabel>
                            in the gateway route example were <code>/chapter</code>, rather than
                                <code>/</code>, then:</para>
                        <itemizedlist>
                            <listitem>
                                <para>A request to <code>www.example.com/chapter/page</code> would
                                    be re-written to <code>myservicea.svc.cluster.local/page</code>. Since
                                        <code>chapter</code> was the matched prefix, it would be
                                    removed in the re-written request. </para>
                            </listitem>
                            <listitem>
                                <para>A request to <code>www.example.com/chapter1</code> would be
                                    rewritten to <code>myservicea.svc.cluster.local/1</code>. Again,
                                        <code>chapter</code> was removed, since it was the matched
                                    prefix, but <code>/1</code> would be added to the rewritten
                                    request from the original request. </para>
                            </listitem>
                        </itemizedlist>
                        <para>Provided the virtual service’s virtual router has a route defined with
                            a prefix of <code>/1</code> or <code>/page</code>, the request would be
                            routed to a virtual node. If the virtual service's virtual router
                            doesn't have such a route however, the request would be dropped. This
                            behavior enables you to minimize the number of gateway routes that are
                            needed, but does require you to ensure that you have routes for a
                            virtual service’s virtual router for each of the expected prefixes that
                            may be requested. Learn more about <link linkend="virtual_services"
                                endterm="virtual_services.title"/>, <link linkend="virtual_routers"
                                endterm="virtual_routers.title"/>, and <link linkend="routes"
                                endterm="routes.title"/>.</para>
                        <important>
                            <itemizedlist>
                                <listitem>
                                    <para>You can't specify either <code>/aws-appmesh*</code> or
                                            <code>/aws-app-mesh*</code> for <guilabel>Match
                                            prefix</guilabel>. These prefixes are reserved for
                                        future &MESH; internal use.</para>
                                </listitem>
                                <listitem>
                                    <para>If multiple gateway routes are defined, then a request is
                                        matched to the route with the longest prefix. For example,
                                        if two gateway routes existed, with one having a prefix of
                                            <code>/chapter</code> and one having a prefix of
                                            <code>/</code>, then a request for
                                            <code>www.example.com/chapter/</code> would be matched
                                        to the gateway route with the <code>/chapter</code>
                                        prefix.</para>
                                </listitem>
                            </itemizedlist>
                        </important>
                    </listitem>
                    <listitem>
                        <para><guilabel>grpc</guilabel> &endash; Specify your gRPC <guilabel>Service
                            name</guilabel>. Your gRPC service acts as an API for your
                            application and is defined with ProtoBuf. For more information about
                            gRPC, see <ulink url="https://grpc.io/docs/what-is-grpc/core-concepts/"
                                >grpc.io</ulink>. </para>
                        <important>
                            <para>You can't specify <code>/aws.app-mesh*</code> or
                                    <code>aws.appmesh</code> for the <guilabel>Service
                                    name</guilabel>. These service names are reserved for future
                                &MESH; internal use.</para>
                        </important>
                    </listitem>
                </itemizedlist>
            </step>
            <step>
                <para>Select an existing <guilabel>Virtual service name</guilabel>. If none are
                    listed, then you need to create a <link linkend="create-virtual-service">virtual
                        service</link> first.</para>
            </step>
            <step>
                <para>Choose <guilabel>Create gateway route</guilabel> to finish.</para>
            </step>
        </procedure>
    </section>
    <section id="delete-gateway-route">
        <info>
            <title id="delete-gateway-route.title">Deleting a gateway route</title>
        </info>
        <para>To delete a route using the &CLI; version &aws_cli_min_version; or higher, see the
            &CLI; reference for the <ulink type="documentation"
                url="cli/latest/reference/appmesh/delete-gateway-route.html"
                    ><code>delete-gateway-route</code></ulink> command.</para>
        <procedure>
            <title>To delete a gateway route using the &console;</title>
            <step>
                <para>&MESHConsoleSwitch;</para>
            </step>
            <step>
                <para>Choose the mesh that you want to delete a gateway route from. All of the
                    meshes that you own and that have been <link linkend="sharing">shared</link>
                    with you are listed.</para>
            </step>
            <step>
                <para>Choose <guilabel>Virtual gateways</guilabel> in the left navigation.</para>
            </step>
            <step>
                <para>Choose the virtual gateway that you want to delete a gateway route
                    from.</para>
            </step>
            <step>
                <para>In the <guilabel>Gateway routes</guilabel> table, choose the gateway route
                    that you want to delete and select <guilabel>Delete</guilabel>. You can only
                    delete a gateway route if your account is listed for <guilabel>Resource
                        owner</guilabel>.</para>
            </step>
            <step>
                <para>In the confirmation box, type <userinput>delete</userinput> and then select
                        <guilabel>Delete</guilabel>.</para>
            </step>
        </procedure>
    </section>
</section>
