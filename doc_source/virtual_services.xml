<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "file://zonbook/docbookx.dtd"
[
    <!ENTITY % xinclude SYSTEM "file://AWSShared/common/xinclude.mod">
    %xinclude;
    <!ENTITY % phrases-shared SYSTEM "file://AWSShared/common/phrases-shared.ent">
    %phrases-shared;
    <!ENTITY % phrases-appmesh SYSTEM "../shared/phrases-app-mesh.ent"> 
    %phrases-appmesh;
]>
<section role="topic" id="virtual_services">
    <info>
        <title id="virtual_services.title">Virtual services</title>
    </info>
    <para>A virtual service is an abstraction of a real service that is provided by a virtual node
        directly or indirectly by means of a virtual router. Dependent services call your virtual
        service by its <code>virtualServiceName</code>, and those requests are routed to the virtual
        node or virtual router that is specified as the provider for the virtual service.</para>
    <section id="create-virtual-service">
        <info>
            <title id="create-virtual-service.title">Creating a virtual service</title>
        </info>
        <para>To create a virtual service using the &CLI; version &aws_cli_min_version; or higher,
            see the example in the &CLI; reference for the <ulink type="documentation"
                url="cli/latest/reference/appmesh/create-virtual-service.html"
                >create-virtual-service</ulink> command. </para>
        <procedure>
            <title>To create a virtual service using the &console;</title>
            <step>
                <para>&MESHConsoleSwitch;</para>
            </step>
            <step>
                <para>Choose the mesh that you want to create the virtual service in. All of the
                    meshes that you own and that have been <link linkend="sharing">shared</link>
                    with you are listed.</para>
            </step>
            <step>
                <para>Choose <guilabel>Virtual services</guilabel> in the left navigation.</para>
            </step>
            <step>
                <para>Choose <guilabel>Create virtual service</guilabel>.</para>
            </step>
            <step>
                <para>For <guilabel>Virtual service name</guilabel>, choose a name for your virtual
                    service. You can choose any name, but the service discovery name of the real
                    service that you're targeting, such as
                        <code>my-service.default.svc.cluster.local</code>, is recommended to make it
                    easier to correlate your virtual services to real services and so that you don't
                    need to change your code to reference a different name than your code currently
                    references. The name that you specify must resolve to a non-loopback IP address
                    because the app container must be able to successfully resolve the name before
                    the request is sent to the Envoy proxy. You can use any non-loopback IP address
                    because neither the app or proxy containers communicate with this IP address.
                    The proxy communicates with other virtual services through the names youâ€™ve
                    configured for them in App Mesh, not through IP addresses that the names resolve
                    to.</para>
            </step>
            <step>
                <para>For <guilabel>Provider</guilabel>, choose the provider type for your virtual
                    service:</para>
                <itemizedlist>
                    <listitem>
                        <para>If you want the virtual service to spread traffic across multiple
                            virtual nodes, select <guilabel>Virtual router</guilabel> and then
                            choose the virtual router to use from the drop-down menu.</para>
                    </listitem>
                    <listitem>
                        <para>If you want the virtual service to reach a virtual node directly,
                            without a virtual router, select <guilabel>Virtual node</guilabel> and
                            then choose the virtual node to use from the drop-down menu.</para>
                        <note>
                            <para>&MESH; may automatically create a default Envoy route retry policy
                                for each virtual node provider that you define on or after &default-route-retry-policy-date;, even though you can't define such a policy through the &MESH; API.
                                For more information, see <xref linkend="default-retry-policy" endterm="default-retry-policy.title"
                                />.</para>
                        </note>
                    </listitem>
                    <listitem>
                        <para>If you don't want the virtual service to route traffic at this time
                            (for example, if your virtual nodes or virtual router doesn't exist
                            yet), choose <guilabel>None</guilabel>. You can update the provider for
                            this virtual service later.</para>
                    </listitem>
                </itemizedlist>
            </step>
            <step>
                <para>Choose <guilabel>Create virtual service</guilabel> to finish.</para>
            </step>
        </procedure>
    </section>
</section>
